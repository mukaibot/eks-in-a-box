#!/usr/bin/ruby
$LOAD_PATH << 'lib'
PLATFORM = `uname`.chomp.downcase
require 'logger'
require 'optparse'
require 'commands/create'
require 'commands/generate'
require 'eks_config'

logger  = Logger.new(STDOUT)
options = {}

OptionParser.new do |opts|
  opts.banner = "Usage: eks-box [options]"

  opts.on("-oOPERATION", "--operation=OPERATION", "Operation to perform. Valid operations are 'generate', 'create', 'update'") do |o|
    options[:operation] = o
  end

  opts.on("-cCONFIG", "--config=CONFIG", "Configuration file") do |c|
    options[:config] = c
  end

  opts.on("-h", "--help", "Prints this help") do
    puts opts
    exit
  end
end.parse!

abort "Not sure what I should do. Run eks-box --help" if options.empty?

if options.dig(:operation) == 'create'
  abort "--config not provided" if options[:config].nil?
  config = EksConfig.new
  YAML.load_file(options[:config])
    .map { |pair| config.send("#{pair.first}=", pair.last) }
  logger.info "Using config from file #{options[:config]}"
  Commands::Create.call(config, logger)
else
  Commands::Generate.call
end
